# Render Blueprint for Loop Tool
# Monorepo: Backend API + Frontend

services:
  # ============================================================================
  # BACKEND API (Python/FastAPI)
  # ============================================================================
  - type: web
    name: loop-auto-api
    runtime: python
    region: frankfurt  # EU region for GDPR compliance + Supabase proximity
    plan: starter
    branch: main
    rootDir: backend  # Monorepo: Run from backend directory
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn src.api:app --host 0.0.0.0 --port $PORT --workers 2
    healthCheckPath: /health
    autoDeploy: true

    envVars:
      # ========== REQUIRED - Database ==========
      - key: SUPABASE_URL
        sync: false

      - key: SUPABASE_KEY
        sync: false

      # ========== REQUIRED - Bolagsverket OAuth2 ==========
      - key: BOLAGSVERKET_CLIENT_ID
        sync: false

      - key: BOLAGSVERKET_CLIENT_SECRET
        sync: false

      # ========== Application Settings ==========
      - key: CACHE_TTL_HOURS
        value: "24"

      - key: LOG_LEVEL
        value: "INFO"

      - key: LOG_FORMAT
        value: "json"

      - key: CORS_ORIGINS
        value: "*"

      - key: MAX_BATCH_SIZE
        value: "10"

      - key: REQUEST_TIMEOUT
        value: "15"

      - key: CONNECT_TIMEOUT
        value: "5"

      # ========== Rate Limiting ==========
      - key: ALLABOLAG_DELAY
        value: "1.0"

      - key: BOLAGSVERKET_DELAY
        value: "0.5"

      # ========== Resilience ==========
      - key: MAX_RETRIES
        value: "3"

      - key: RETRY_BACKOFF
        value: "1.5"

      - key: ENABLE_CIRCUIT
        value: "true"

      - key: CIRCUIT_FAILURES
        value: "5"

      - key: CIRCUIT_RECOVERY
        value: "60"

      # ========== Performance ==========
      - key: MAX_PARALLEL
        value: "2"

      - key: BATCH_WORKERS
        value: "5"

      - key: ENABLE_ASYNC
        value: "true"

      - key: ENABLE_METRICS
        value: "true"

  # ============================================================================
  # FRONTEND (Static Site - Optional)
  # ============================================================================
  # Uncomment to deploy frontend to Render
  # - type: web
  #   name: loop-tool-frontend
  #   runtime: static
  #   branch: main
  #   buildCommand: npm ci && npm run build
  #   staticPublishPath: dist
  #   headers:
  #     - path: /*
  #       name: Cache-Control
  #       value: public, max-age=31536000
  #   routes:
  #     - type: rewrite
  #       source: /*
  #       destination: /index.html

# ============================================================================
# DEPLOYMENT NOTES
# ============================================================================
#
# This is a monorepo with:
# - /backend - Python FastAPI API (deployed to Render)
# - /src - React/TypeScript Frontend
#
# Backend is deployed to: https://loop-auto-api.onrender.com
#
# Set required env vars in Render Dashboard:
# - SUPABASE_URL
# - SUPABASE_KEY (service_role key)
# - BOLAGSVERKET_CLIENT_ID
# - BOLAGSVERKET_CLIENT_SECRET
#
